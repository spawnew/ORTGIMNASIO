@model IEnumerable<Payment>
@{
    ViewData["Title"] = "Pending Payments";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-clock-history"></i> Pending Payments</h1>
    <a asp-action="Create" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> New Payment
    </a>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> These payments are waiting for confirmation or processing
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Member</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Plan</th>
                        <th>Transaction Ref</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        @foreach (var payment in Model)
                        {
                            <tr>
                                <td>
                                    <strong>@payment.PaymentDate.ToString("MMM dd, yyyy")</strong><br>
                                    <small class="text-muted">@payment.PaymentDate.ToString("HH:mm")</small>
                                </td>
                                <td>
                                    <strong>@payment.Member?.FullName</strong><br>
                                    <small class="text-muted">@payment.Member?.Email</small>
                                </td>
                                <td>
                                    <strong class="text-primary">$@payment.Amount.ToString("0.00")</strong>
                                </td>
                                <td>
                                    @switch (payment.PaymentMethod)
                                    {
                                        case PaymentMethod.Cash:
                                            <span class="badge bg-success"><i class="bi bi-cash"></i> Cash</span>
                                            break;
                                        case PaymentMethod.CreditCard:
                                            <span class="badge bg-primary"><i class="bi bi-credit-card"></i> Credit Card</span>
                                            break;
                                        case PaymentMethod.DebitCard:
                                            <span class="badge bg-info"><i class="bi bi-credit-card-2-front"></i> Debit Card</span>
                                            break;
                                        case PaymentMethod.BankTransfer:
                                            <span class="badge bg-secondary"><i class="bi bi-bank"></i> Bank Transfer</span>
                                            break;
                                        default:
                                            <span class="badge bg-dark">@payment.PaymentMethod</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    @if (payment.MembershipPlan != null)
                                    {
                                        <span class="badge bg-info">@payment.MembershipPlan.Name</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(payment.TransactionReference))
                                    {
                                        <code class="small">@payment.TransactionReference</code>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(payment.Notes))
                                    {
                                        <small>@payment.Notes</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success btn-sm"
                                                onclick="updateStatus(@payment.Id, @((int)PaymentStatus.Completed), 'Completed')"
                                                title="Mark as Completed">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                onclick="updateStatus(@payment.Id, @((int)PaymentStatus.Failed), 'Failed')"
                                                title="Mark as Failed">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm"
                                                onclick="updateStatus(@payment.Id, @((int)PaymentStatus.Cancelled), 'Cancelled')"
                                                title="Cancel Payment">
                                            <i class="bi bi-slash-circle"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                <p class="mt-3">No pending payments</p>
                                <a asp-action="Create" class="btn btn-primary">Create New Payment</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    @if (Model.Any())
    {
        <div class="card-footer">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0 text-muted">Total Pending: @Model.Count() payment(s)</p>
                </div>
                <div class="col-md-6 text-end">
                    <strong>Total Amount: $@Model.Sum(p => p.Amount).ToString("0.00")</strong>
                </div>
            </div>
        </div>
    }
</div>

<!-- Hidden form for status updates -->
<form id="statusUpdateForm" method="post" asp-action="UpdateStatus" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="paymentId" />
    <input type="hidden" name="status" id="paymentStatus" />
</form>

@section Scripts {
    <script>
        function updateStatus(paymentId, status, statusName) {
            if (confirm(`Are you sure you want to mark this payment as ${statusName}?`)) {
                document.getElementById('paymentId').value = paymentId;
                document.getElementById('paymentStatus').value = status;
                document.getElementById('statusUpdateForm').submit();
            }
        }
    </script>
}
